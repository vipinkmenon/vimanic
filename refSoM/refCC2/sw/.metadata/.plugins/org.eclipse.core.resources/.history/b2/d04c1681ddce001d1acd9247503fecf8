#include "rssiCalc.h"
#include "xil_io.h"
#include "attenuator.h"

float rssiVals[] = {2.56,2.51,2.47,2.42,2.37,2.32,2.27,2.22,2.18,2.12,2.07,2.03,1.98,1.94,1.89,1.84,1.79,1.74,1.69,1.64,1.6,1.55,1.5,1.45,1.4,1.35,1.3,1.26,1.21,1.16,1.11,1.06,1.01,0.96,0.92,0.87,0.82,0.78,0.73,0.68,0.64,0.61,0.586,0.568,0.557,0.548,0.543,0.54,0.538,0.537,0.536};


void initRSSI(rssi *myrssi, u32 baseAddr){
	myrssi->BaseAddress = baseAddr;
}




float getRSSI(rssi *myrssi){
	int adcIn;
	adcIn = Xil_In32(myrssi->BaseAddress);
	return (adcIn*3.3)/((1<<16)-1);
}



int findClosestIndex(float num,float *floatArray,int arraySize){
	int i;
	int index=0;
	float diff;
	float prevDiff  = 10000.0;
	for(i=0;i<arraySize;i++){
		if(floatArray[i] > num)
			diff = floatArray[i]-num;
		else
			diff = num-floatArray[i];

		if(diff < prevDiff){
			index = i;
			prevDiff = diff;
		}
	}
	xil_printf("%d\n\r",index);
	return index;
}


int  getAttn(float rssiValue){
	int index;
	index = findClosestIndex(rssiValue,rssiVals,sizeof(rssiVals));
	return 2*index;
}

int configAttenuator(attenuator *attn,int totalAttenuation){
	float maxAttenuation = 31.75;
	int allAtMaxFlag = 1;
	while(totalAttenuation != 0){
		for(int i=0;i<3;i=i+1)
		{
			if(totalAttenuation == 0){
				allAtMaxFlag = 0;
				break;
			}
			if(attn->attVal[i] != maxAttenuation){
				attn->attVal[i] = attn->attVal[i]+1;
				totalAttenuation--;
				allAtMaxFlag = 0;
			}
		}
		if(allAtMaxFlag == 1){
			print("Error all attenuators at maximum value. Cannot configure new value");
			return -1;
		}
	}
	writeAttenuator(attn,1,attn->attVal[0]);
	writeAttenuator(attn,2,attn->attVal[1]);
	writeAttenuator(attn,3,attn->attVal[2]);
	return 0;
}








